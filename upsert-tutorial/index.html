<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map.prototype.upsert Tutorial</title>
    <link rel="stylesheet" href="style.css"> <!-- Link to CSS file for styling -->
</head>
<body>
    <div class="container">
        <!-- Sidebar for Table of Contents -->
        <aside class="sidebar">
            <h2>Table of Contents</h2>
            <ul>
                <li><a href="#ecmascript">ECMAScript®</a></li>
                <li><a href="#introduction">Introduction</a></li>
                <li><a href="#whats-covered">What’s Covered in This Tutorial?</a></li>
                <li><a href="#proposal-overview">The Map.prototype.upsert Proposal</a></li>
                <li><a href="#installation">Installing Mozilla Unified</a></li>
                <li><a href="#specification">How to Read the ECMA-262 Language Specification</a></li>
                <li><a href="#searchfox">Using Searchfox</a></li>
                <li><a href="#implementation">Implementation</a></li>
                <li><a href="#issues">Issues with the Original Proposal</a></li>
                <li><a href="#new-proposal">Explaining the New Proposal</a></li>
                <li><a href="#implementing-new-proposal">Implementing the New Proposal</a></li>
                <li><a href="#ecmarkup">Writing the Specification in Ecmarkup</a></li>
                <li><a href="#optimization">Optimization</a></li>
                <li><a href="#testing">Testing with Test262</a></li>
            </ul>
        </aside>

        <!-- Main Content Area -->
        <div class="content">
            <header>
                <h1>Map.prototype.upsert Tutorial</h1>
                <p>Welcome to this detailed tutorial on how to implement and understand the Map.prototype.upsert proposal in JavaScript™.</p>
                <a href="initial-emplace-spec/Map.prototype.emplace.html">Here is the original specification!</a>
                <a href="key-value-callback-spec/Map.prototype.getOrInsert.html">Here is the new specification!</a>
            </header>

            <main>
                <!-- ECMAScript® Section (non-collapsible) -->
                <section id="ecmascript">
                    <h2>ECMAScript®</h2>
                    <p>
                        JavaScript™ is standardized by ECMAScript® and specified in the 
                        <a href="https://ecma-international.org/publications-and-standards/standards/ecma-262/" target="_blank">
                            ECMA-262 language specification
                        </a>, 
                        which is maintained by Ecma International through the 
                        <a href="https://tc39.es/" target="_blank">TC39 committee</a>. 
                        ECMAScript® defines the core features of the language, providing a standard that ensures consistency across different JavaScript™ engines. 
                        Major engines like 
                        <a href="https://v8.dev/" target="_blank">V8</a> (used in Chrome and Node.js), 
                        <a href="https://developer.apple.com/documentation/javascriptcore" target="_blank">JavaScriptCore</a> (Safari), 
                        and 
                        <a href="https://spidermonkey.dev/" target="_blank">SpiderMonkey</a> (Firefox) 
                        implement these specifications, allowing developers to write code that behaves similarly across different environments.
                    </p>
                    <p>
                        SpiderMonkey, the engine developed by Mozilla, powers JavaScript™ execution in Firefox and supports the development of new language features. 
                        This tutorial focuses on working within SpiderMonkey to implement and test a new JavaScript™ proposal, providing insight into both the ECMAScript® 
                        standardization process and the inner workings of a JavaScript™ engine.
                    </p>
                </section>

                <!-- Introduction Section (non-collapsible) -->
                <section id="introduction">
                    <h2>Introduction</h2>
                    <p>Welcome to this detailed tutorial on how to implement and understand the Map.prototype.upsert proposal. This guide is tailored to help both beginners and advanced developers learn how to contribute to JavaScript™ language development by implementing a new feature in SpiderMonkey, Mozilla's JavaScript™ engine. We’ll cover all the necessary steps, from downloading and setting up the development environment to writing the upsert method and testing it with the official test suite, Test262.</p>
                    <p>We'll start with an introduction to the Map.prototype.upsert proposal, highlighting its benefits for developers. From there, you'll be guided through setting up the development environment using Mozilla's SpiderMonkey JavaScript™ engine. You'll then implement the upsert method using both self-hosted JavaScript™ and (a little bit of) C++, ensuring alignment with the ECMAScript® specification.</p>
                    <p>By the end of this tutorial, you'll have implemented a fully functional upsert method and gained valuable insight into the process of designing, testing, and standardizing JavaScript™ features.</p>
                </section>

                <!-- What's Covered Section (non-collapsible) -->
                <section id="whats-covered">
                    <h2>What’s Covered in This Tutorial?</h2>
                    <ul>
                        <li>The Map.prototype.upsert Proposal: Learn what this proposal is, how it works, and why it’s beneficial for JavaScript™ developers.</li>
                        <li>Setting Up the Development Environment: How to download and build Mozilla Unified, the repository that contains SpiderMonkey.</li>
                        <li>Implementing the Proposal: Implementing the upsert method in self-hosted JavaScript™ and C++.</li>
                        <li>Debugging and Testing: How to test your implementation using Test262 and run custom scripts.</li>
                        <li>Optimizing Your Code: Learn about performance considerations and optimizations.</li>
                        <li>Contributing to the ECMAScript® Standard: Understand how to write specification-compliant code and contribute to ECMAScript®.</li>
                    </ul>
                </section>

                <!-- Collapsible Sections for Detailed Topics -->
                <section class="collapsible" id="proposal-overview">
                    <h2>The Map.prototype.upsert Proposal</h2>
                    <div class="content-body">
                        <p>[Details on the Map.prototype.upsert proposal go here]</p>
                    </div>
                </section>

                <section class="collapsible" id="installation">
                    <h2>Installing Mozilla Unified</h2>
                    <div class="content-body">
                        <p>[Installation steps go here]</p>
                    </div>
                </section>

                <section class="collapsible" id="specification">
                    <h2>How to Read the ECMA-262 Language Specification</h2>
                    <div class="content-body">
                        <p>[Specification reading guide goes here]</p>
                    </div>
                </section>

                <section class="collapsible" id="searchfox">
                    <h2>Using Searchfox</h2>
                    <div class="content-body">
                        <p>[Searchfox usage tips go here]</p>
                    </div>
                </section>

                <section class="collapsible" id="implementation">
                    <h2>Implementation</h2>
                    <div class="content-body">
                        <p>[Implementation guide goes here]</p>
                    </div>
                </section>

                <section class="collapsible" id="issues">
                    <h2>Issues with the Original Proposal</h2>
                    <div class="content-body">
                        <p>[Explanation of issues with the original proposal goes here]</p>
                    </div>
                </section>

                <section class="collapsible" id="new-proposal">
                    <h2>Explaining the New Proposal</h2>
                    <div class="content-body">
                        <p>[Details of the new proposal go here]</p>
                    </div>
                </section>

                <section class="collapsible" id="implementing-new-proposal">
                    <h2>Implementing the New Proposal</h2>
                    <div class="content-body">
                        <p>[Guide to implementing the new proposal goes here]</p>
                        <p>In this section, we will cover how to install and use Ecmarkup to write specifications for proposals.
                            Ecmarkup is a markup language that is designed for technical specifications.
                            This allows the authors to visualize and format complex algorithms, clauses and terms in a way that is both readable and structured.
                            Regarding JavaScript-proposals, Ecmarkup provides a solid framework to document new algorithms or implementations so they align with the ECMAScript®-standards. </p>
                        <p>  We will start with setting up the necessary tools to be able to use Ecmarkup, such as Node.js and Ecmarkup itself.
                            Furthermore, we will check out how to format specification using Ecmarkup before guiding you through how to build your specification into an HTML document. </p>
                        <ul>
                            <li><p><strong>Installing Node.js and Node Package Manager</strong></p>
                                <div class="tab-container">
                                    <div class="tabs">
                                        <button class="tab-button active" data-tab="ecmarkup-windows-tab">Windows</button>
                                        <button class="tab-button" data-tab="ecmarkup-mac-tab">Mac</button>
                                        <button class="tab-button" data-tab="ecmarkup-linux-tab">Linux</button>
                                    </div>
                                    <div class="tab-content active" id="ecmarkup-windows-tab">
                                        <p>NPM windows.</p>
                                    </div>
                                    <div class="tab-content" id="ecmarkup-mac-tab">
                                        <p>NPM mac</p>
                                    </div>
                                    <div class="tab-content" id="ecmarkup-linux-tab">
                                        <p>NPM linux</p>
                                    </div>
                                </div>
                                <details>
                                    <summary>
                                        <b>Windows</b>
                                    </summary>

                                    <ol>
                                        <li><p>First go to Node.js official website (<a href="https://nodejs.org/en">https://nodejs.org/en</a>), and download the Windows Installer (recommended version).</p>
                                        </li>
                                        <li><p>Run the installer and follow the instructions (make sure to check the box that says &quot;Automatically install necessary tools&quot;).</p>
                                        </li>
                                        <li><p>Verify installation by opening Command Prompt and typing:</p>
                                        </li>
                                    </ol>
                                    <pre><code class="language-sh">node -v
npm -v
</code></pre>
                                    <p>This should return the versions of Node.js and npm.</p>
                                </details>

                                <details>
                                    <summary><b>Mac</b></summary>

                                    <ol>
                                        <li>Open Terminal</li>
                                        <li>Install Node.js via Homebrew by running the following command:</li>
                                    </ol>
                                    <pre><code class="language-sh">brew install node
</code></pre>
                                    <ol start="3">
                                        <li>Verify installation by typing:</li>
                                    </ol>
                                    <pre><code class="language-sh">node -v
npm -v
</code></pre>
                                </details>

                                <details>
                                    <summary><b>Linux</b></summary>

                                    <ol>
                                        <li>Open Terminal</li>
                                        <li>Update your package list:</li>
                                    </ol>
                                    <pre><code class="language-sh">sudo apt update
</code></pre>
                                    <ol start="3">
                                        <li>Install Node.js by running:</li>
                                    </ol>
                                    <pre><code class="language-sh">sudo apt install node.js spm
</code></pre>
                                    <ol start="4">
                                        <li>Verify the installation:</li>
                                    </ol>
                                    <pre><code class="language-sh">node -v
npm -v
</code></pre>
                                </details>

                            </li>
                            <li><p><strong>Installing <a href="https://tc39.es/ecmarkup/" target="_blank">Ecmarkup</a></strong></p>
                                <ul>
                                    <li>Windows/Mac/Linux<ol>
                                        <li>Open Command Prompt (Windows) or Terminal (Mac/Linux)</li>
                                        <li>Run the following command to install Ecmarkup globally:</li>
                                    </ol>
                                        <pre><code class="language-sh">npm install -g ecmarkup
</code></pre>
                                        <ol start="3">
                                            <li>Verify that Ecmarkup has been installed by typing:</li>
                                        </ol>
                                        <pre><code class="language-sh">ecmarkup --version
</code></pre>
                                        <p>You have now installed Ecmarkup.</p>
                                    </li>
                                </ul>
                            </li>
                            <li><p><strong>How to write ecmarkup</strong></p>
                                <p>Ecmarkup is a markup language used for writing technical specifications. It has a syntax similar to <code>HTML</code>, making it intuitive for those familiar with web development. Here&#39;s a simple example of what an algorithm in a <code>.emu</code> file looks like (<code>.emu</code> is the file ending of an ecmarkup file):</p>
                                <pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;meta charset=&quot;utf8&quot;&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css&quot;&gt;
&lt;script src=&quot;./spec.js&quot;&gt;&lt;/script&gt;
&lt;pre class=&quot;metadata&quot;&gt;
title: Your Document Title
stage: The proposals stage
contributors: Your name
&lt;/pre&gt;

&lt;emu-clause id=&quot;sec-greater-than-five&quot;&gt;
  &lt;h1&gt;greaterThanFive(_value_)&lt;/h1&gt;
  &lt;p&gt;When the greaterThanFive method is called, the following steps are taken:&lt;/p&gt;
  &lt;emu-alg&gt;
    1. Let _x_ be _value_.
    1. If Type(_x_) is not Number, throw a *TypeError* exception.
    1. If _x_ is NaN, throw a *RangeError* exception.
    1. If _x_ is less than 0, return *false*.
    1. If _x_ is greater than 5, return *true*.
    1. Else:
      1. Return *false*.
  &lt;/emu-alg&gt;
&lt;/emu-clause&gt;
</code></pre>
                                <p><strong>Note:</strong> This is just an example of how an Ecmarkup file should be structured. The algorithm itself is illustrative and not a real-world example.</p>
                            </li>
                            <li><p><strong>How to format spec text using Ecmarkup</strong></p>
                                <p>Formatting spec text using Ecmarkup involves understanding the differences between what each reperesents. ECMAScript® is a scripting language specification, while Ecmarkup is a specialized markup language used to write and format <strong>specification documents</strong> for ECMAScript® and other web standards.</p>
                                <ol>
                                    <li><p><strong>Understanding why we need Ecmarkup</strong></p>
                                        <p>Ecmarkup combines HTML-like tags with specific syntactic constructs to write formal specifications. If you visit the <a href="https://tc39.es/ecma262/" target="_blank">TC39 official website</a> for ECMA-262, you can read ECMAScript® with hyperlinks to used terms, algorithms, and syntax definitions, allowing for easy navigation between different sections and components of the specification. These specifications are made with Ecmarkup.</p>
                                    </li>
                                    <li><p><strong>Basic translation steps</strong></p>
                                        <ul>
                                            <li><code>&lt;emu-alg&gt;</code>: Defines an algorithm.</li>
                                            <li><code>&lt;emu-clause&gt;</code>: Defines a clause/section in the specification.</li>
                                            <li>Underscores are used to refer to variables (<code>_varname_</code>).</li>
                                            <li><code>&lt;emu-xref&gt;</code>: Link to other sections, clauses or algorithms within the specification.</li>
                                            <li><code>*someBoldText*</code>: Make bold text with <code>*</code>.</li>
                                            <li>Use double square brackets (<code>[[...]]</code>) when documenting or referring to the internal, hidden mechanisms of objects that are not directly accessible in the JavaScript™ language but are crucial for the implementation and behavior of the object.</li>
                                        </ul>
                                    </li>
                                </ol>
                            </li>
                            <li><p>The function <code>upsert(key, callbackfn)</code> in ecmarkup (can also be found under the spec-folder in this proposal)</p>
                                <pre><code class="language-html">  &lt;!DOCTYPE html&gt;
  &lt;meta charset=&quot;utf8&quot;&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css&quot;&gt;
  &lt;script src=&quot;./spec.js&quot;&gt;&lt;/script&gt;
  &lt;pre class=&quot;metadata&quot;&gt;
  title: Map.prototype.upsert
  stage: 2
  contributors: Lauritz Angeltveit
  &lt;/pre&gt;

  &lt;emu-clause id=&quot;sec-map.prototype.upsert&quot;&gt;
    &lt;h1&gt;Map.prototype.upsert ( _key_, _callbackfn_ )&lt;/h1&gt;
    &lt;p&gt;When the upsert method is called the following steps are taken:&lt;/p&gt;
    &lt;emu-alg&gt;
      1. Let _M_ be the *this* value.
      1. Perform ? RequireInternalSlot(_M_, [[MapData]]).
      1. If IsCallable(_callbackfn_) is false, throw a *TypeError* exception.
      1. For each Record { [[Key]], [[Value]] } _e_ that is an element of _M_.[[MapData]], do:
        1. If _e_.[[Key]] is not empty and SameValueZero(_e_.[[Key]], _key_) is *true*, return _e_.[[Value]].
      1. Let _inserted_ be ? Call(_callbackfn_, _key_).
      1. Set _e_.[[Value]] to _inserted_.
      1. Return _e_.[[Value]].
    &lt;/emu-alg&gt;
  &lt;/emu-clause&gt;
</code></pre>
                            </li>
                            <li><p><strong>Building the spec</strong></p>
                                <p>To build the spec, use the following command:</p>
                                <pre><code class="language-sh">  ecmarkup spec.emu out.html
</code></pre>
                                <p>In this command:</p>
                                <ul>
                                    <li><code>spec.emu</code> is the source file where you have written your specification using Ecmarkup.</li>
                                    <li><code>out.html</code> is the output file, which is a runnable HTML document.
                                        To verify that your specification has been built correctly, simply drag-and-drop the <code>out.html</code> file into a web browser.</li>
                                </ul>
                            </li>
                        </ul>

                    </div>
                </section>

                <section class="collapsible" id="ecmarkup">
                    <h2>Writing the Specification in Ecmarkup</h2>
                    <div class="content-body">
                        <p>[Guide for writing in Ecmarkup goes here]</p>
                    </div>
                </section>

                <section class="collapsible" id="optimization">
                    <h2>Optimization</h2>
                    <div class="content-body">
                        <p>[Optimization techniques go here]</p>
                    </div>
                </section>

                <section class="collapsible" id="testing">
                    <h2>Testing with Test262</h2>
                    <div class="content-body">
                        <p>[Testing guide goes here]</p>
                    </div>
                </section>
            </main>

            <footer>
                <p>&copy; 2024 - Tutorial on Implementing Map.prototype.upsert</p>
            </footer>
        </div>
    </div>

    <!-- Script to enable collapsible sections -->
    <script>
        document.querySelectorAll('.collapsible').forEach(section => {
            section.querySelector('h2').addEventListener('click', () => {
                section.querySelector('.content-body').classList.toggle('hidden');
            });
        });
    </script>
</body>
</html>
